generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum InvoiceStatus {
  UPLOADED           // Fichier uploadé sur Vercel Blob
  OCR_PROCESSING     // OCR Textract en cours
  OCR_COMPLETED      // OCR terminé avec succès
  OCR_FAILED         // OCR échoué
  AI_PROCESSING      // Analyse Claude en cours
  AI_COMPLETED       // Analyse IA terminée
  PENDING_VALIDATION // En attente de validation utilisateur
  VALIDATED          // Validé par l'utilisateur
  EXPORTED           // Exporté vers Sage
  ERROR              // Erreur générale
}

enum ExportStatus {
  PENDING   // Export en attente
  COMPLETED // Export terminé
  FAILED    // Export échoué
}

model Invoice {
  id            String         @id @default(cuid())

  // Fichier
  fileName      String
  fileUrl       String         // URL Vercel Blob
  fileSize      Int            // Taille en bytes
  mimeType      String         // application/pdf, image/jpeg, etc.

  // Métadonnées temporelles
  uploadedAt    DateTime       @default(now())
  processedAt   DateTime?      // Quand OCR + IA terminés
  validatedAt   DateTime?      // Quand validé par utilisateur
  exportedAt    DateTime?      // Quand exporté vers Sage

  // Statut et progression
  status        InvoiceStatus  @default(UPLOADED)

  // Données OCR brutes (encryptées pour sécurité)
  ocrRawData    String?        @db.Text
  ocrText       String?        @db.Text // Texte brut extrait
  ocrConfidence Float?         // Score de confiance 0-1

  // Données extraites par OCR + IA
  supplierName  String?
  supplierVAT   String?        // Numéro TVA intracommunautaire
  supplierSIREN String?
  supplierAddress String?      @db.Text

  invoiceNumber String?
  invoiceDate   DateTime?
  dueDate       DateTime?

  // Montants
  amountHT      Decimal?       @db.Decimal(12, 2)
  amountTVA     Decimal?       @db.Decimal(12, 2)
  amountTTC     Decimal?       @db.Decimal(12, 2)
  tvaRate       Decimal?       @db.Decimal(5, 2) // En %
  currency      String         @default("EUR")

  // Catégorisation comptable
  accountNumber  String?       // Ex: 401000 (compte fournisseur)
  expenseAccount String?       // Ex: 606000 (compte de charge)
  journalCode    String?       // Ex: ACH (achats)
  analyticalCode String?       // Code analytique optionnel

  // Lignes de facture (stockées en JSON)
  lineItems     Json?          // Array de {description, qty, price, amount}

  // Validation utilisateur
  validatedBy   String?        // User ID/email
  validationNotes String?      @db.Text

  // Gestion des erreurs
  errorMessage  String?        @db.Text
  retryCount    Int            @default(0)
  lastRetryAt   DateTime?

  // Relations
  accountingEntries AccountingEntry[]
  exports           SageExport[]      @relation("InvoiceExports")

  @@index([status])
  @@index([invoiceDate])
  @@index([uploadedAt])
  @@index([supplierName])
  @@map("invoices")
}

model AccountingEntry {
  id           String   @id @default(cuid())
  invoiceId    String
  invoice      Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Écriture comptable Sage
  journalCode  String   // ACH, VTE, BQ, OD
  entryDate    DateTime // Date de l'écriture
  accountNumber String  // Compte général (401xxx, 6xxxx, 445xxx)
  label        String   // Libellé de l'écriture

  // Montants
  debit        Decimal  @db.Decimal(12, 2)
  credit       Decimal  @db.Decimal(12, 2)

  // Analytique (optionnel)
  analyticalCode String?

  // Métadonnées
  createdAt    DateTime @default(now())

  @@index([invoiceId])
  @@index([journalCode])
  @@index([entryDate])
  @@map("accounting_entries")
}

model SageExport {
  id            String       @id @default(cuid())

  // Export
  exportDate    DateTime     @default(now())
  fileName      String       // export_20250116_143022.TRA
  fileUrl       String?      // URL Vercel Blob si stocké
  fileSize      Int?         // Taille en bytes

  // Contenu
  invoiceCount  Int          // Nombre de factures dans l'export
  totalAmount   Decimal      @db.Decimal(12, 2) // Montant total TTC

  // Statut
  status        ExportStatus @default(PENDING)

  // Erreurs
  errorMessage  String?      @db.Text

  // Relations
  invoices      Invoice[]    @relation("InvoiceExports")

  // Métadonnées
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([exportDate])
  @@index([status])
  @@map("sage_exports")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  role      String   @default("USER") // USER, ADMIN
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}
